#!/usr/bin/env python3

import subprocess
import time
import tempfile
from argparse import ArgumentParser
from pathlib import Path


def getFileSize(src):
    return Path(src).stat().st_size


def getPathSize(src):
    src = Path(src)

    size = None

    if src.is_file():
        size = getFileSize(src)

    elif src.is_dir():
        size = sum(getFileSize(x) for x in Path(src).rglob('*'))

    else:
        print('we got here')

    return size


def runCommand(args):
    print(f'Running command: {args}')

    start = time.perf_counter()

    subprocess.run(
        args,
        stderr=subprocess.STDOUT,
        stdout=subprocess.DEVNULL
    )

    end = time.perf_counter() - start
    return end


def do7zip(src, dst, *args):
    cmd = (
        '7zz',
        'a',
        *args,
        dst,
        src
    )
    return runCommand(cmd)


def doNanoZip(src, dst, *args):
    cmd = (
        'nz',
        'a',
        *args,
        dst,
        src
    )
    return runCommand(cmd)


def doZip(src, dst, *args):
    cmd = (
        'zip',
        *args,
        dst,
        src
    )
    return runCommand(cmd)


def doZpaq(src, dst, *args):
    cmd = (
        'zpaq',
        'a',
        dst,
        src,
        *args
    )
    return runCommand(cmd)


def doBrotli(src, dst, *args):
    cmd = (
        'brotli',
        *args,
        '-o',
        dst,
        src
    )
    return runCommand(cmd)


def doBzip3(src, dst, *args):
    cmd = (
        'bzip3',
        *args,
        src
    )
    return runCommand(cmd)


def doCmix(src, dst, *args):
    cmd = (
        'cmix',
        *args,
        src,
        dst
    )
    return runCommand(cmd)


def doFxz(src, dst, *args):
    cmd = (
        'fxz',
        *args,
        src
    )
    return runCommand(cmd)


def doLizard(src, dst, *args):
    cmd = (
        'lizard',
        *args,
        src,
        dst
    )
    return runCommand(cmd)


def doLrzipNext(src, dst, *args):
    cmd = (
        'lrzip-next',
        *args,
        '-o',
        dst,
        src
    )
    return runCommand(cmd)


def doLZ4(src, dst, *args):
    cmd = (
        'lz4',
        *args,
        src,
        dst
    )
    return runCommand(cmd)


def doLzop(src, dst, *args):
    cmd = (
        'lzop',
        *args,
        '-o',
        dst,
        src
    )
    return runCommand(cmd)


def doPBzip2(src, dst, *args):
    cmd = (
        'pbzip2',
        *args,
        src
    )
    return runCommand(cmd)


def doPigz(src, dst, *args):
    cmd = (
        'pigz',
        *args,
        src
    )
    return runCommand(cmd)


def doPLzip(src, dst, *args):
    cmd = (
        'plzip',
        *args,
        '-o',
        dst,
        src
    )
    return runCommand(cmd)


def doRzip64(src, dst, *args):
    cmd = (
        'rzip64',
        *args,
        '-o',
        dst,
        src
    )
    return runCommand(cmd)


def doZstd(src, dst, *args):
    cmd = (
        'zstd',
        *args,
        '-o',
        dst,
        src
    )
    return runCommand(cmd)


def go(func, src, dst, *args):
    in_size = getPathSize(src)
    in_size_str = f'{round(in_size / (1024*1024), 2)} MB'

    duration = round(func(src, dst, *args), 4)
    duration_str = f'{duration} sec(s)'

    out_size = getPathSize(dst)
    out_size_str = f'{round(out_size / (1024*1024), 2)} MB'

    speed = (out_size / duration) / (1024*1024)
    speed_str = f'{round(speed, 2)} MB/s'

    compression = ((out_size / in_size) * 100) - 100
    compression_str = f'{round(compression, 2)}%'

    print(
        func.__name__,
        duration_str,
        compression_str,
        in_size_str,
        out_size_str,
        speed_str
    )


def main():
    parser = ArgumentParser()

    parser.add_argument('-i', nargs=1)

    args = parser.parse_args()

    if args.i:
        go(doZstd, args.i[0], f'{args.i[0]}.zst', '-k0')
    else:
        parser.print_help()


if __name__ == '__main__':
    main()

